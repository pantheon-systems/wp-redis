# Name of the GitHub Actions workflow.
name: Test-Behat

# Controls when the action will run.
on:
  pull_request:
  workflow_dispatch:
  schedule:
    # Runs nightly at 00:00 UTC.
    - cron: "0 0 * * *"

# Defines the jobs to run in the workflow.
jobs:
  test-behat:
    # Use the latest Ubuntu runner.
    runs-on: ubuntu-latest

    # This runs all job steps inside the specified Docker container image.
    container:
      image: quay.io/pantheon-public/build-tools-ci:8.x-php8.2
      options: --user root:root

    steps:
      # Checks out your repository under $GITHUB_WORKSPACE, so your job can access it.
      - name: Checkout code
        uses: actions/checkout@v4

      # Caches the vendor directory to speed up subsequent builds.
      # The cache is invalidated when composer.json changes.
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: vendor
          key: ${{ runner.os }}-composer-${{ hashFiles('composer.json') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      # Installs project dependencies using Composer.
      - name: Install dependencies
        run: composer install -n --prefer-dist

      # Sets up environment variables that will be available to subsequent steps in the job.
      - name: Set up environment variables
        run: |
          echo "WORDPRESS_ADMIN_PASSWORD=$(openssl rand -hex 8)" >> $GITHUB_ENV
          echo "TERMINUS_ENV=ci-${{ github.run_id }}" >> $GITHUB_ENV
          echo "TERMINUS_SITE=wp-redis" >> $GITHUB_ENV
          echo "SITE_ENV=wp-redis.ci-${{ github.run_id }}" >> $GITHUB_ENV
          echo "WORDPRESS_ADMIN_USERNAME=pantheon" >> $GITHUB_ENV
          echo "WORDPRESS_ADMIN_EMAIL=no-reply@getpantheon.com" >> $GITHUB_ENV

      # Configures SSH to automatically accept new host keys.
      - name: Configure SSH
        run: echo "StrictHostKeyChecking no" >> "$HOME/.ssh/config"

      # Configures Composer with the GitHub token for accessing private repositories.
      # The GITHUB_TOKEN is automatically provided by GitHub Actions.
      - name: Configure GitHub Token for Composer
        run: composer config -g github-oauth.github.com ${{ secrets.GITHUB_TOKEN }}

      # Authenticates with Pantheon's Terminus CLI using a machine token stored as a secret.
      # This step only runs if the TERMINUS_TOKEN secret is set in the repository.
      - name: Login to Terminus
        if: ${{ secrets.TERMINUS_TOKEN != '' }}
        run: terminus auth:login --machine-token=$TERMINUS_TOKEN
        env:
          TERMINUS_TOKEN: ${{ secrets.TERMINUS_TOKEN }}

      # Validates the fixture version by running a script.
      - name: Validate fixture version
        run: ./bin/validate-fixture-version.sh

      # Prepares the environment for Behat tests.
      - name: Prepare Behat tests
        run: ./bin/behat-prepare.sh

      # Runs the Behat test suite.
      - name: Run Behat tests
        run: ./bin/behat-test.sh --strict

      # This cleanup step runs regardless of whether the preceding steps succeeded or failed.
      - name: Cleanup after tests
        if: always()
        run: ./bin/behat-cleanup.sh
